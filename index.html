<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PoE2 Currency Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        body {
            background: #0b0f14;
        }

        .card {
            background: #121821;
        }

        .muted {
            color: #9fb0c3;
        }

        .badge {
            background: rgba(8, 193, 119, 0.1);
            color: #08c177;
        }

        input,
        select {
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
            border: 1px solid #334155 !important;
            border-radius: 0.75rem !important;
            height: 2.75rem !important;
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #08c177 !important;
            box-shadow: 0 0 0 1px #08c177;
        }

        .btn {
            @apply rounded-xl px-3 py-2 border border-slate-700 hover:bg-slate-800/60;
        }

        /* Uniform number inputs */
        .input {
            height: 2.5rem;
            /* lock height */
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
            border: 1px solid #334155 !important;
            border-radius: 0.75rem !important;
            padding: 0 0.75rem !important;
        }

        /* Remove spinners (Chrome/Edge) */
        .input::-webkit-outer-spin-button,
        .input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Remove spinners (Firefox) */
        .input[type=number] {
            -moz-appearance: textfield;
        }

        /* Row: [want input] : [have input] */
        .ratio-row {
            display: grid;
            grid-template-columns: minmax(140px, 1fr) auto minmax(140px, 1fr);
            align-items: center;
            gap: .5rem;
        }

        .ratio-row .sep {
            width: 1.25rem;
            text-align: center;
            color: #94a3b8;
        }
    </style>
</head>

<body class="text-slate-100">
    <div id="app" class="max-w-6xl mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-semibold tracking-tight">PoE2 Currency Calculator</h1>
            <p class="muted mt-2">Input your exchange rates and item values. The tool compares all possible paths
                (direct or via another currency)
                to show which option gives you the most Chaos, Exalts, or Divines.</p>
        </header>

        <!-- Rates -->
        <section class="card rounded-2xl p-6 shadow-lg mb-6">
            <h2 class="text-xl font-semibold mb-4">1) Directional Exchange Rates</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="rounded-xl border border-slate-700 p-4 bg-slate-900/40">
                    <div class="text-sm font-medium">Exalted ↔ Chaos</div>

                    <!-- Row 1: Want Chaos : Have Exalted -->
                    <label class="block text-xs muted mt-3 mb-1">Want Chaos : Have Exalted</label>
                    <div class="ratio-row">
                        <input class="input" type="number" step="0.01" v-model.number="ui.pairs.CE.wantC"
                            @input="applyPair('c','e', ui.pairs.CE.wantC, ui.pairs.CE.haveE)" />
                        <span class="sep">:</span>
                        <input class="input" type="number" step="0.01" v-model.number="ui.pairs.CE.haveE"
                            @input="applyPair('c','e', ui.pairs.CE.wantC, ui.pairs.CE.haveE)" />
                    </div>

                    <!-- Row 2: Want Exalted : Have Chaos -->
                    <label class="block text-xs muted mt-3 mb-1">Want Exalted : Have Chaos</label>
                    <div class="ratio-row">
                        <input class="input" type="number" step="0.01" v-model.number="ui.pairs.CE.wantE"
                            @input="applyPair('e','c', ui.pairs.CE.wantE, ui.pairs.CE.haveC)" />
                        <span class="sep">:</span>
                        <input class="input" type="number" step="0.01" v-model.number="ui.pairs.CE.haveC"
                            @input="applyPair('e','c', ui.pairs.CE.wantE, ui.pairs.CE.haveC)" />
                    </div>

                    <!-- Derived -->
                    <div class="text-xs muted mt-3">
                        Derived:
                        <div>
                            <ul>
                                <li>1 Exalted → Chaos = {{ fmt(rates.exToChaos) }} c</li>
                                <li>Chaos per 1 Exalted = {{ fmt(rates.chaosPerEx) }}</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="rounded-xl border border-slate-700 p-4 bg-slate-900/40">
                    <div class="text-sm font-medium">Divine ↔ Exalted</div>

                    <!-- Row 1: Want Exalted : Have Divine -->
                    <label class="block text-xs muted mt-3 mb-1">Want Exalted : Have Divine</label>
                    <div class="ratio-row">
                        <input class="input" type="number" step="0.01" v-model.number="ui.pairs.DE.wantE"
                            @input="applyPair('e','d', ui.pairs.DE.wantE, ui.pairs.DE.haveD)" />
                        <span class="sep">:</span>
                        <input class="input" type="number" step="0.01" v-model.number="ui.pairs.DE.haveD"
                            @input="applyPair('e','d', ui.pairs.DE.wantE, ui.pairs.DE.haveD)" />
                    </div>

                    <!-- Row 2: Want Divine : Have Exalted -->
                    <label class="block text-xs muted mt-3 mb-1">Want Divine : Have Exalted</label>
                    <div class="ratio-row">
                        <input class="input" type="number" step="0.01" v-model.number="ui.pairs.DE.wantD"
                            @input="applyPair('d','e', ui.pairs.DE.wantD, ui.pairs.DE.haveE)" />
                        <span class="sep">:</span>
                        <input class="input" type="number" step="0.01" v-model.number="ui.pairs.DE.haveE"
                            @input="applyPair('d','e', ui.pairs.DE.wantD, ui.pairs.DE.haveE)" />
                    </div>

                    <!-- Derived -->
                    <div class="text-xs muted mt-3">
                        Derived:
                        <div>
                            <ul>
                                <li>1 Divine → Exalted = {{ fmt(rates.divToEx) }} ex</li>
                                <li>Exalted per 1 Divine = {{ fmt(rates.exPerDiv) }}</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="rounded-xl border border-slate-700 p-4 bg-slate-900/40">
                    <div class="text-sm font-medium">Divine ↔ Chaos</div>

                    <!-- Row 1: Want Chaos : Have Divine -->
                    <label class="block text-xs muted mt-3 mb-1">Want Chaos : Have Divine</label>
                    <div class="ratio-row">
                        <input class="input" type="number" step="0.01" v-model.number="ui.pairs.DC.wantC"
                            @input="applyPair('c','d', ui.pairs.DC.wantC, ui.pairs.DC.haveD)" />
                        <span class="sep">:</span>
                        <input class="input" type="number" step="0.01" v-model.number="ui.pairs.DC.haveD"
                            @input="applyPair('c','d', ui.pairs.DC.wantC, ui.pairs.DC.haveD)" />
                    </div>

                    <!-- Row 2: Want Divine : Have Chaos -->
                    <label class="block text-xs muted mt-3 mb-1">Want Divine : Have Chaos</label>
                    <div class="ratio-row">
                        <input class="input" type="number" step="0.01" v-model.number="ui.pairs.DC.wantD"
                            @input="applyPair('d','c', ui.pairs.DC.wantD, ui.pairs.DC.haveC)" />
                        <span class="sep">:</span>
                        <input class="input" type="number" step="0.01" v-model.number="ui.pairs.DC.haveC"
                            @input="applyPair('d','c', ui.pairs.DC.wantD, ui.pairs.DC.haveC)" />
                    </div>

                    <!-- Derived -->
                    <div class="text-xs muted mt-3">
                        Derived:
                        <div>
                            <ul>
                                <li>1 Divine → Chaos = {{ fmt(rates.divToChaos) }} c</li>
                                <li>Chaos per 1 Divine = {{ fmt(rates.chaosPerDiv) }}</li>
                            </ul>
                        </div>
                    </div>
                </div>

            </div>
            <p class="text-xs muted mt-3">We always pick the <span class="badge px-2 py-0.5 rounded-full">best
                    path</span> (direct or 1‑hop) between currencies.</p>
        </section>

        <!-- Ranking Preference -->
        <section class="card rounded-2xl p-6 shadow-lg mb-6">
            <h2 class="text-xl font-semibold mb-2">2) Ranking Preference</h2>
            <div class="flex items-center gap-4">
                <label class="text-sm">Rank by:</label>
                <select v-model="rankBy">
                    <option value="chaos">Chaos Equivalent</option>
                    <option value="exalt">Exalted Equivalent</option>
                    <option value="div">Divine Equivalent</option>
                </select>
            </div>
            <p class="text-xs muted mt-2">This changes how we decide what is “best.” For <strong>Selling</strong>, we
                pick the method that yields the most value in your chosen ranking currency. For <strong>Buying</strong>,
                we pick the method that costs the least in that ranking currency.</p>
        </section>

        <!-- SELL ITEMS -->
        <section class="card rounded-2xl p-6 shadow-lg mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">3) Items to Sell</h2>
                <button @click="addItem" class="btn">+ Add Item</button>
            </div>

            <div v-for="(it, idx) in items" :key="it.id"
                class="rounded-2xl border border-slate-700 p-4 bg-slate-900/40 mb-4">
                <h3 class="text-lg font-semibold mb-3">{{ it.name || ('Item ' + (idx+1)) }}</h3>

                <!-- inputs -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm mb-1 muted">Name</label>
                        <input v-model="it.name" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1 muted">Quantity</label>
                        <input v-model.number="it.qty" type="number" min="0" step="0.01" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1 muted">Offer (Chaos each)</label>
                        <input v-model.number="it.perChaos" type="number" step="0.01" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1 muted">Offer (Exalted each)</label>
                        <input v-model.number="it.perEx" type="number" step="0.01" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1 muted">Offer (Divine each)</label>
                        <input v-model.number="it.perDiv" type="number" step="0.01" />
                    </div>
                </div>

                <!-- result cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div v-for="row in sellRows(idx)" :key="row.key"
                        class="rounded-2xl border border-slate-700 p-4 bg-slate-900/60">
                        <div class="flex items-center justify-between">
                            <div class="text-sm uppercase tracking-wide muted">Method</div>
                            <div class="flex items-center gap-2">
                                <div v-if="row.best" class="badge px-2 py-0.5 rounded-full text-xs">Best</div>
                                <div class="badge px-2 py-0.5 rounded-full text-xs"
                                    style="background:rgba(148,163,184,0.15);color:#cbd5e1;">
                                    Comparing by: {{ rankBy }}
                                </div>
                            </div>
                        </div>

                        <h4 class="text-lg font-semibold mt-1">{{ row.label }}</h4>

                        <!-- equivalents -->
                        <div class="mt-3 text-sm grid grid-cols-1 gap-1">
                            <div class="flex justify-between">
                                <span class="muted">Chaos-equiv</span>
                                <span>{{ fmt(row.asChaos) }} c</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="muted">Exalt-equiv</span>
                                <span>{{ fmt(row.asEx) }} ex</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="muted">Divine-equiv</span>
                                <span>{{ fmt(row.asDiv) }} d</span>
                            </div>
                        </div>

                        <!-- ranked outcomes -->
                        <div class="mt-3 text-xs">
                            <div class="muted mb-1">Ranked outcomes:</div>
                            <ol class="list-decimal pl-5 space-y-0.5">
                                <li v-for="(r,i) in row.rank" :key="r.code">
                                    <span class="font-medium">{{ r.label }}</span> —
                                    {{ fmt(r.val) }} {{ r.unit }}
                                    <span class="muted">via</span> {{ pathString(r.path) }}
                                    <span v-if="i===0" class="ml-1 inline-block px-1.5 py-0.5 rounded-full text-[10px]"
                                        style="background:rgba(8,193,119,.15);color:#08c177;">Best</span>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BUY ITEMS -->
        <section class="card rounded-2xl p-6 shadow-lg mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">4) Items to Buy</h2>
                <button @click="addBuy" class="btn">+ Add Buy</button>
            </div>

            <div v-for="(b, idx) in buys" :key="b.id"
                class="rounded-2xl border border-slate-700 p-4 bg-slate-900/40 mb-4">
                <h3 class="text-lg font-semibold mb-3">{{ b.name || ('Buy ' + (idx+1)) }}</h3>

                <!-- inputs -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm mb-1 muted">Name</label>
                        <input v-model="b.name" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1 muted">Quantity</label>
                        <input v-model.number="b.qty" type="number" min="0" step="0.01" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1 muted">Cost (Chaos total for qty)</label>
                        <input v-model.number="b.costChaos" type="number" step="0.01" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1 muted">Cost (Exalted total for qty)</label>
                        <input v-model.number="b.costEx" type="number" step="0.01" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1 muted">Cost (Divine total for qty)</label>
                        <input v-model.number="b.costDiv" type="number" step="0.01" />
                    </div>
                </div>

                <!-- result cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div v-for="row in buyRows(idx)" :key="row.key"
                        class="rounded-2xl border border-slate-700 p-4 bg-slate-900/60">
                        <div class="flex items-center justify-between">
                            <div class="text-sm uppercase tracking-wide muted">Pay with</div>
                            <div class="flex items-center gap-2">
                                <div v-if="row.best" class="badge px-2 py-0.5 rounded-full text-xs">Best</div>
                                <div class="badge px-2 py-0.5 rounded-full text-xs"
                                    style="background:rgba(148,163,184,0.15);color:#cbd5e1;">
                                    Comparing by: {{ rankBy }}
                                </div>
                            </div>
                        </div>

                        <h4 class="text-lg font-semibold mt-1">{{ row.label }}</h4>

                        <!-- costs -->
                        <div class="mt-3 text-sm grid grid-cols-1 gap-1">
                            <div class="flex justify-between">
                                <span class="muted">Chaos-equiv cost</span>
                                <span>{{ fmt(row.asChaos) }} c</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="muted">Exalt-equiv cost</span>
                                <span>{{ fmt(row.asEx) }} ex</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="muted">Divine-equiv cost</span>
                                <span>{{ fmt(row.asDiv) }} d</span>
                            </div>
                        </div>

                        <!-- ranked costs (cheapest first) -->
                        <div class="mt-3 text-xs">
                            <div class="muted mb-1">Ranked (cheapest → priciest):</div>
                            <ol class="list-decimal pl-5 space-y-0.5">
                                <li v-for="(r,i) in row.rank" :key="r.code">
                                    <span class="font-medium">{{ r.label }}</span> —
                                    {{ fmt(r.val) }} {{ r.unit }}
                                    <span class="muted">via</span> {{ pathString(r.path) }}
                                    <span v-if="i===0" class="ml-1 inline-block px-1.5 py-0.5 rounded-full text-[10px]"
                                        style="background:rgba(8,193,119,.15);color:#08c177;">Cheapest</span>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script>
        const { createApp } = Vue

        const mkItem = () => ({ id: Math.random().toString(36).slice(2), name: '', qty: 1, perChaos: 0, perEx: 0, perDiv: 0 })
        const mkBuy = () => ({ id: Math.random().toString(36).slice(2), name: '', qty: 1, costChaos: 0, costEx: 0, costDiv: 0 })

        createApp({
            data() {
                return {
                    rates: { exToChaos: 1.25, chaosPerEx: 1.28, divToEx: 49, exPerDiv: 47, divToChaos: 58, chaosPerDiv: 60 },
                    items: [mkItem()], buys: [mkBuy()], rankBy: 'chaos',
                    inputMode: 'mr',  // 'mr' = market ratio, 'direct' = direct numbers,
                    ui: {
                        // initial values just examples; user can type over them
                        pairs: {
                            // Chaos ↔ Exalted
                            CE: { wantC: 1, haveE: 1.35, wantE: 1, haveC: 1.28 },

                            // Divine ↔ Exalted
                            DE: { wantE: 67, haveD: 1, wantD: 1, haveE: 66.67 },

                            // Divine ↔ Chaos
                            DC: { wantC: 48.67, haveD: 1, wantD: 1, haveC: 49 }
                        }
                    }
                }
            },
            methods: {
                // ---------- Utilities ----------
                fmt(n) {
                    if (!isFinite(n)) return '—';
                    const a = Math.abs(n);
                    const dp = a >= 10 ? 2 : a >= 1 ? 3 : 4;
                    return Number(n.toFixed(dp));
                },
                labelFor(code) {
                    return code === 'c' ? 'Chaos' : code === 'e' ? 'Exalted' : code === 'd' ? 'Divine' : code;
                },
                pathString(path) {
                    if (!path || !path.length) return '—';
                    return path.map(this.labelFor).join(' → ');
                },

                addItem() { this.items.push({ id: Math.random().toString(36).slice(2), name: '', qty: 1, perChaos: 0, perEx: 0, perDiv: 0 }); },
                addBuy() { this.buys.push({ id: Math.random().toString(36).slice(2), name: '', qty: 1, costChaos: 0, costEx: 0, costDiv: 0 }); },
                unitFor(code) { return code === 'c' ? 'c' : code === 'e' ? 'ex' : 'd'; },
                rankList(entries, { order = 'desc' } = {}) {
                    // entries: [{code:'c', label:'Chaos', val:..., path:[...]}, ...]
                    const cmp = order === 'asc'
                        ? (a, b) => (a.val - b.val)
                        : (a, b) => (b.val - a.val);
                    return entries
                        .filter(e => isFinite(e.val))
                        .sort(cmp);
                },

                /**
                 * Pair-style setter for rates coming from:
                 *   "Want <W> : Have <H>  [wantQty] : [haveQty]"
                 * We set rate(H->W) = wantQty / haveQty and keep all your existing rate keys in sync.
                 * Currency codes: 'c' chaos, 'e' exalted, 'd' divine
                 */
                // Independent-rate setter from "Want : Have" rows.
                // want, have ∈ {'c','e','d'}; wantQty, haveQty are the two input boxes.
                // We ONLY set the canonical directional field that corresponds to THIS row.
                // No inverse writing, no UI syncing.
                applyPair(want, have, wantQty, haveQty) {
                    const W = String(want), H = String(have);
                    const wn = Number(wantQty), hn = Number(haveQty);
                    if (!W || !H || W === H) return;
                    if (!isFinite(wn) || !isFinite(hn) || wn <= 0 || hn <= 0) return;

                    // Row rate as written in UI: wn of WANT per hn of HAVE
                    const rowRate = wn / hn;

                    // Exalted ↔ Chaos
                    if (H === 'e' && W === 'c') {
                        // Want Chaos : Have Exalted → "chaos per exalt"
                        this.rates.exToChaos = rowRate;
                        return;
                    }
                    if (H === 'c' && W === 'e') {
                        // Want Exalted : Have Chaos → the UI gives "ex per chaos"
                        // Our canonical field here is "Chaos per 1 Exalted" → invert the row
                        this.rates.chaosPerEx = 1 / rowRate;
                        return;
                    }

                    // Divine ↔ Exalted
                    if (H === 'd' && W === 'e') {
                        // Want Exalted : Have Divine → "ex per div" (direct match)
                        this.rates.divToEx = rowRate;
                        return;
                    }
                    if (H === 'e' && W === 'd') {
                        // Want Divine : Have Exalted → "div per ex"
                        // Canonical is "Exalted per 1 Divine" → invert
                        this.rates.exPerDiv = 1 / rowRate;
                        return;
                    }

                    // Divine ↔ Chaos
                    if (H === 'd' && W === 'c') {
                        // Want Chaos : Have Divine → "chaos per div" (direct match)
                        this.rates.divToChaos = rowRate;
                        return;
                    }
                    if (H === 'c' && W === 'd') {
                        // Want Divine : Have Chaos → "div per chaos"
                        // Canonical is "Chaos per 1 Divine" → invert
                        this.rates.chaosPerDiv = 1 / rowRate;
                        return;
                    }
                },

                // ---------- Conversion engine ----------
                rateDirect(src, dst) {
                    if (src === dst) return 1;
                    const r = this.rates;
                    switch (`${src}->${dst}`) {
                        case 'e->c': return r.exToChaos;                 // chaos per exalt
                        case 'c->e': return 1 / (r.chaosPerEx || NaN);   // ex per chaos
                        case 'd->e': return r.divToEx;                   // ex per divine
                        case 'e->d': return 1 / (r.exPerDiv || NaN);     // div per exalt
                        case 'd->c': return r.divToChaos;                // chaos per divine
                        case 'c->d': return 1 / (r.chaosPerDiv || NaN);  // div per chaos
                        default: return NaN;
                    }
                },

                bestRateWithPath(src, dst) {
                    if (src === dst) return { rate: 1, path: [src] };
                    const cur = ['c', 'e', 'd'];
                    let best = { rate: NaN, path: [] };

                    const consider = (rate, path) => {
                        if (isFinite(rate) && rate > 0 && (!isFinite(best.rate) || rate > best.rate)) {
                            best = { rate, path };
                        }
                    };

                    // direct
                    const dir = this.rateDirect(src, dst);
                    consider(dir, [src, dst]);

                    // one intermediate (covers all without cycles in 3-currency world)
                    for (const mid of cur) {
                        if (mid === src || mid === dst) continue;
                        const r1 = this.rateDirect(src, mid);
                        const r2 = this.rateDirect(mid, dst);
                        consider(r1 * r2, [src, mid, dst]);
                    }
                    return best;
                },

                convertWithPath(amount, src, dst) {
                    const { rate, path } = this.bestRateWithPath(src, dst);
                    return { amount: isFinite(rate) ? amount * rate : NaN, path };
                },
                convert(amount, src, dst) {
                    return this.convertWithPath(amount, src, dst).amount;
                },

                // ---------- Rows for SELL ----------
                sellRows(idx) {
                    const it = this.items[idx], q = Number(it.qty) || 0;
                    const chaos = q * (+it.perChaos || 0), ex = q * (+it.perEx || 0), div = q * (+it.perDiv || 0);

                    const c2e = this.convertWithPath(chaos, 'c', 'e');
                    const c2d = this.convertWithPath(chaos, 'c', 'd');
                    const e2c = this.convertWithPath(ex, 'e', 'c');
                    const e2d = this.convertWithPath(ex, 'e', 'd');
                    const d2c = this.convertWithPath(div, 'd', 'c');
                    const d2e = this.convertWithPath(div, 'd', 'e');

                    const rows = [
                        {
                            key: 'c', label: `Sell for Chaos (${it.perChaos || 0} c each)`,
                            asChaos: chaos, chaosPath: ['c'],
                            asEx: c2e.amount, exPath: c2e.path,
                            asDiv: c2d.amount, divPath: c2d.path
                        },
                        {
                            key: 'e', label: `Sell for Exalted (${it.perEx || 0} ex each)`,
                            asChaos: e2c.amount, chaosPath: e2c.path,
                            asEx: ex, exPath: ['e'],
                            asDiv: e2d.amount, divPath: e2d.path
                        },
                        {
                            key: 'd', label: `Sell for Divines (${it.perDiv || 0} d each)`,
                            asChaos: d2c.amount, chaosPath: d2c.path,
                            asEx: d2e.amount, exPath: d2e.path,
                            asDiv: div, divPath: ['d']
                        },
                    ];

                    // Best pill by user-selected ranking currency
                    let bestIdx = 0, bestVal = -Infinity;
                    rows.forEach((r, i) => {
                        const v = this.rankBy === 'chaos' ? r.asChaos : this.rankBy === 'exalt' ? r.asEx : r.asDiv;
                        if (v > bestVal) { bestVal = v; bestIdx = i; }
                    });
                    rows[bestIdx].best = true;

                    // Per-row ranked outcomes (desc by amount) + path annotation
                    rows.forEach(r => {
                        r.rank = this.rankList([
                            { code: 'c', label: 'Chaos', val: r.asChaos, unit: 'c', path: r.chaosPath || ['c'] },
                            { code: 'e', label: 'Exalted', val: r.asEx, unit: 'ex', path: r.exPath || ['e'] },
                            { code: 'd', label: 'Divine', val: r.asDiv, unit: 'd', path: r.divPath || ['d'] },
                        ], { order: 'desc' });
                    });

                    return rows;
                },

                // ---------- Rows for BUY ----------
                buyRows(idx) {
                    const b = this.buys[idx];
                    const chaos = +b.costChaos || 0, ex = +b.costEx || 0, div = +b.costDiv || 0;

                    const c2e = this.convertWithPath(chaos, 'c', 'e');
                    const c2d = this.convertWithPath(chaos, 'c', 'd');
                    const e2c = this.convertWithPath(ex, 'e', 'c');
                    const e2d = this.convertWithPath(ex, 'e', 'd');
                    const d2c = this.convertWithPath(div, 'd', 'c');
                    const d2e = this.convertWithPath(div, 'd', 'e');

                    const rows = [
                        {
                            key: 'c', label: `Pay ${this.fmt(chaos)} chaos`,
                            asChaos: chaos, chaosPath: ['c'],
                            asEx: c2e.amount, exPath: c2e.path,
                            asDiv: c2d.amount, divPath: c2d.path
                        },
                        {
                            key: 'e', label: `Pay ${this.fmt(ex)} exalted`,
                            asChaos: e2c.amount, chaosPath: e2c.path,
                            asEx: ex, exPath: ['e'],
                            asDiv: e2d.amount, divPath: e2d.path
                        },
                        {
                            key: 'd', label: `Pay ${this.fmt(div)} divines`,
                            asChaos: d2c.amount, chaosPath: d2c.path,
                            asEx: d2e.amount, exPath: d2e.path,
                            asDiv: div, divPath: ['d']
                        },
                    ];

                    // Cheapest pill by selected ranking currency
                    let bestIdx = 0, bestVal = Infinity;
                    rows.forEach((r, i) => {
                        const v = this.rankBy === 'chaos' ? r.asChaos : this.rankBy === 'exalt' ? r.asEx : r.asDiv;
                        if (v < bestVal) { bestVal = v; bestIdx = i; }
                    });
                    rows[bestIdx].best = true;

                    // Per-row ranked costs (asc = cheapest first) + path
                    rows.forEach(r => {
                        r.rank = this.rankList([
                            { code: 'c', label: 'Chaos', val: r.asChaos, unit: 'c', path: r.chaosPath || ['c'] },
                            { code: 'e', label: 'Exalted', val: r.asEx, unit: 'ex', path: r.exPath || ['e'] },
                            { code: 'd', label: 'Divine', val: r.asDiv, unit: 'd', path: r.divPath || ['d'] },
                        ], { order: 'asc' });
                    });

                    return rows;
                },

            }
        }).mount('#app')
    </script>
</body>

</html>